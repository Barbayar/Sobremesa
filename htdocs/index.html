<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="component/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="component/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="component/seiyria-bootstrap-slider/css/bootstrap-slider.css" rel="stylesheet" type="text/css">
    <link href="component/smalot-bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css">
    <link href="component/sb-admin/sb-admin.css" rel="stylesheet"><!-- https://raw2.github.com/IronSummitMedia/startbootstrap/master/templates/sb-admin-v2/css/sb-admin.css -->

    <title>Sobremesa</title>

    <script id="template-lunch" type="text/x-handlebars-template">
        <div class="panel panel-default" id="panelLunch{{lunchId}}">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseLunch{{lunchId}}" class="">
                        <i class="fa fa-cutlery fa-fw"></i> {{theme}}
                    </a>
                    <div class="btn-group pull-right">
                        {{#isMine this}}
                            <button type="button" class="btn btn-warning" onclick="showEditLunchForm('{{lunchId}}',
                                            '{{theme}}', '{{location}}', '{{description}}', '{{beginTime}}',
                                            '{{endTime}}', '{{minPeople}}', '{{maxPeople}}')">Edit</button>
                            <button type="button" class="btn btn-danger" onclick="Sobremesa.confirm('Confirmation', 'Do you really want to delete the lunch?', deleteLunch, {{lunchId}})">Delete</button>
                        {{else}}
                            {{#isJoined this}}
                                <button type="button" class="btn btn-danger" onclick="Sobremesa.confirm('Confirmation', 'Do you really want to cancel joining the lunch?', cancelLunch, {{lunchId}})">Cancel</button>
                            {{else}}
                                <button type="button" class="btn btn-success" onclick="joinLunch({{lunchId}})">Join</button>
                            {{/isJoined}}
                        {{/isMine}}
                    </div>
                </h4>
                <div class="clearfix"></div>
            </div>
            <div id="collapseLunch{{lunchId}}" class="panel-collapse collapse{{#unless @index}} in{{/unless}}" style="height: auto;">
                <div class="panel-body">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-info fa-fw"></i> Information
                        </div>
                        <div class="panel-body" style="height: auto;">
                            <strong>Description</strong><br />
                            {{description}}<br /><br />
                            <strong>Number of People</strong><br />
                            {{minPeople}} ~ {{maxPeople}}<br /><br />
                            <strong>Time</strong><br />
                            {{stringTime beginTime}} ~ {{stringTime endTime}}<br /><br />
                            <strong>Location</strong><br />
                            <a href="{{googleMapURL location}}" target="_blank">{{location}}</a><br /><br />
                            <strong>Members</strong><br />
                            <img src="{{avatarURL this 50}}" alt="{{displayName}}" class="img-circle"> {{displayName}} (Host)
                            {{#each members}}
                            <img src="{{avatarURL this 50}}" alt="{{displayName}}" class="img-circle"> {{displayName}}
                            {{/each}}
                        </div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-comments fa-fw"></i> Comments
                        </div>
                        {{#if comments}}
                        <div class="panel-body" style="height: auto;">
                            <ul class="chat">
                                {{#each comments}}
                                <li class="left clearfix">
                                    <span class="chat-img pull-left">
                                        <img src="{{avatarURL this 50}}" alt="{{displayName}}" class="img-circle">
                                    </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <strong class="primary-font">{{displayName}}</strong>
                                            <small class="pull-right text-muted"><i class="fa fa-clock-o fa-fw"></i>
                                                {{readableTime createdTime}} ago
                                            </small>
                                        </div>
                                        <p>{{content}}</p>
                                    </div>
                                </li>
                                {{/each}}
                            </ul>
                        </div>
                        {{/if}}
                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="btn-input" type="text" class="form-control input-sm" placeholder="Type your comment here...">
                                    <span class="input-group-btn">
                                        <button class="btn btn-primary btn-sm" id="btn-chat">
                                            Submit
                                        </button>
                                    </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script id="template-lunches" type="text/x-handlebars-template">
        <div class="panel-group" id="accordion">
            {{#each lunches}}
                {{> lunch}}
            {{/each}}
        </div>
    </script>
</head>

<body>
    <div class="modal fade" id="lunchForm" tabindex="-1" role="dialog" aria-labelledby="lunchFormTitle" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                    <h4 class="modal-title" id="lunchFormTitle">Create</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Theme</label>
                        <input class="form-control" id="lunchFormTheme" placeholder="English Lunch">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input class="form-control" id="lunchFormLocation" placeholder="Restaurante La Sobremesa">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" rows="3" id="lunchFormDescription" placeholder="Everybody can join this lunch. You don't have to be a native speaker."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Begin Time</label>
                        <div class="input-group date form_datetime">
                            <input class="form-control" size="16" type="text" value="" id="lunchFormBeginTime" readonly>
                            <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <div class="input-group date form_datetime">
                            <input class="form-control" size="16" type="text" value="" id="lunchFormEndTime" readonly>
                            <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Number of People</label>
                        <div class="row">
                            <div class="col-lg-2">
                                <input class="form-control" id="lunchFormNumberOfPeopleMin" readonly>
                            </div>
                            <div class="col-lg-8">
                                <input id="lunchFormNumberOfPeople" type="text" class="span2" value=""/>
                            </div>
                            <div class="col-lg-2">
                                <input class="form-control" id="lunchFormNumberOfPeopleMax" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="lunchFormSubmit">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div id="wrapper">
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Sobremesa</a>
            </div>
            <ul class="nav navbar-top-links navbar-right">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <img alt="" class="img-circle" height="50" src="" width="50" id="avatar">
                        <span id="displayName"></span>
                        <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#"><i class="fa fa-user fa-fw"></i> User Profile</a>
                        </li>
                        <li class="divider"></li>
                        <li><a onClick="logout()"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>
        <nav class="navbar-default navbar-static-side" role="navigation">
            <div class="sidebar-collapse">
                <ul class="nav" id="side-menu">
                    <li>
                        <a href="index.html"><i class="fa fa-home fa-fw"></i> Home</a>
                    </li>
                    <li>
                        <a href="#" onClick="showCreateLunchForm()"><i class="fa fa-plus fa-fw"></i> Create</a>
                    </li>
                    <li>
                        <a href="https://github.com/Barbayar/Sobremesa" target="_blank"><i class="fa fa-github fa-fw"></i> Fork me on Github</a>
                    </li>
                </ul>
            </div>
        </nav>

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">Home</h1>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8" id="mainView">
                </div>
                <div class="col-lg-4">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-info fa-fw"></i> Informations
                        </div>
                        <div class="panel-body">
                            Under Construction
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="component/jquery/dist/jquery.min.js"></script>
    <script src="component/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="component/handlebars/handlebars.min.js"></script>
    <script src="component/ember/ember.min.js"></script>
    <script src="component/jquery.cookie/jquery.cookie.js"></script>
    <script src="component/modernizr/modernizr.js"></script>
    <script src="component/momentjs/min/moment.min.js"></script>
    <script src="component/seiyria-bootstrap-slider/js/bootstrap-slider.js"></script>
    <script src="component/smalot-bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="component/sobremesa/sobremesa.js"></script>

    <script type="text/javascript">
        Handlebars.registerHelper('avatarURL', function(user, size) {
            return Sobremesa.getAvatarURL(user, size);
        });

        Handlebars.registerHelper('readableTime', function(timestamp) {
            return Sobremesa.timestampToReadableString(timestamp);
        });

        Handlebars.registerHelper('googleMapURL', function(location) {
            return 'https://maps.google.com/?q=' + encodeURIComponent(location);
        });

        Handlebars.registerHelper('stringTime', function(timestamp) {
            return Sobremesa.timestampToString(timestamp);
        });

        Handlebars.registerHelper('isMine', function(conditional, options) {
            var me = Sobremesa.getMe();

            if (conditional.userId == me.userId) {
                return options.fn(this);
            }

            return options.inverse(this);
        });

        Handlebars.registerHelper('isJoined', function(conditional, options) {
            var me = Sobremesa.getMe();

            for (var i in conditional.members) {
                if (conditional.members[i].userId == me.userId) {
                    return options.fn(this);
                }
            }

            return options.inverse(this);
        });

        Handlebars.registerPartial('lunch', $('#template-lunch').html());

        var Renders = {
            lunches: Handlebars.compile($("#template-lunches").html()),
            lunch: Handlebars.compile($("#template-lunch").html())
        }
    </script>

    <script type="text/javascript">
    $(function() {
        Sobremesa.callApi('lunch/available', 'GET', null, function(result) {
            $('#mainView').html(Renders.lunches({
                lunches: result
            }));
        }, function(error) {
            Sobremesa.alert('Error', 'An unknown error occurred');
        });

        $('#lunchFormNumberOfPeople').slider({
            min: 2,
            max: 20,
            step: 1,
            value: [4, 8],
            tooltip: 'hide'
        }).on('slide', function(event) {
            $('#lunchFormNumberOfPeopleMin').val(event.value[0]);
            $('#lunchFormNumberOfPeopleMax').val(event.value[1]);
        });

        $('.form_datetime').datetimepicker({
            format: Sobremesa.dateFormat,
            autoclose: true,
            pickerPosition: 'bottom-left',
            minuteStep: 10
        });

        var me = Sobremesa.getMe();

        if (me) {
            $('#displayName').html(me.displayName);
            $('#avatar').attr('src', Sobremesa.getAvatarURL(me, 50));
            $('#avatar').attr('alt', me.displayName);
        }
    });

    function updateLunchView(lunchId) {
        Sobremesa.callApi('lunch', 'GET', {lunchId: lunchId}, function(result) {
            $('#panelLunch' + lunchId).html(Renders.lunch(result));
        }, function(error) {
            if (error.status == '400') {
                Sobremesa.alert('Error', 'Invalid parameters');
            } else if (error.status == '404') {
                Sobremesa.alert('Error', 'Couldn\'t find the lunch');
            } else {
                Sobremesa.alert('Error', 'An unknown error occurred');
            }
        });
    }

    function removeLunchView(lunchId) {
        $('#panelLunch' + lunchId).remove();
    }

    function validateLunchForm() {
        var result = {};

        result.theme = $('#lunchFormTheme').val();
        result.location = $('#lunchFormLocation').val();
        result.description = $('#lunchFormDescription').val();
        result.beginTime = Sobremesa.stringToTimestamp($('#lunchFormBeginTime').val());
        result.endTime = Sobremesa.stringToTimestamp($('#lunchFormEndTime').val());
        result.minPeople = $('#lunchFormNumberOfPeopleMin').val();
        result.maxPeople = $('#lunchFormNumberOfPeopleMax').val();

        if (!result.theme) {
            $('#lunchFormTheme').parent().addClass('has-error');

            return false;
        } else {
            $('#lunchFormTheme').parent().removeClass('has-error');
        }

        if (!result.location) {
            $('#lunchFormLocation').parent().addClass('has-error');

            return false;
        } else {
            $('#lunchFormLocation').parent().removeClass('has-error');
        }

        if (!result.description) {
            $('#lunchFormDescription').parent().addClass('has-error');

            return false;
        } else {
            $('#lunchFormDescription').parent().removeClass('has-error');
        }

        if (!result.beginTime || result.beginTime * 1000 < (new Date()).getTime()) {
            $('#lunchFormBeginTime').parent().addClass('has-error');

            return false;
        } else {
            $('#lunchFormBeginTime').parent().removeClass('has-error');
        }

        if (!result.endTime || result.endTime < result.beginTime) {
            $('#lunchFormEndTime').parent().addClass('has-error');

            return false;
        } else {
            $('#lunchFormEndTime').parent().removeClass('has-error');
        }

        if (!result.minPeople) {
            $('#lunchFormNumberOfPeopleMin').parent().addClass('has-error');
            $('#lunchFormNumberOfPeopleMax').parent().addClass('has-error');

            return false;
        } else {
            $('#lunchFormNumberOfPeopleMin').parent().removeClass('has-error');
            $('#lunchFormNumberOfPeopleMax').parent().removeClass('has-error');
        }

        return result;
    }

    function showCreateLunchForm() {
        $('#lunchFormTitle').html('Create');
        $('#lunchFormTheme').val('');
        $('#lunchFormLocation').val('');
        $('#lunchFormDescription').val('');
        $('#lunchFormBeginTime').val('');
        $('#lunchFormEndTime').val('');
        $('#lunchFormNumberOfPeopleMin').val('');
        $('#lunchFormNumberOfPeopleMax').val('');

        $('#lunchFormSubmit').on('click', function(event) {
            var parameters = validateLunchForm();

            if (parameters !== false) {
                Sobremesa.callApi('lunch', 'PUT', parameters, function(result) {
                    parameters.lunchId = result;

                    $('#lunchForm').modal('hide');
                }, function(error) {
                    if (error.status == '400') {
                        Sobremesa.alert('Error', 'Invalid parameters');
                    } else {
                        Sobremesa.alert('Error', 'An unknown error occurred');
                    }
                });
            }
        });

        $('#lunchForm').modal('show');
    }

    function showEditLunchForm(lunchId, theme, location, description, beginTime, endTime, minPeople, maxPeople) {
        $('#lunchFormTitle').html('Edit');
        $('#lunchFormTheme').val(theme);
        $('#lunchFormLocation').val(location);
        $('#lunchFormDescription').val(description);
        $('#lunchFormBeginTime').val(Sobremesa.timestampToString(beginTime));
        $('#lunchFormEndTime').val(Sobremesa.timestampToString(endTime));
        $('#lunchFormNumberOfPeopleMin').val(minPeople);
        $('#lunchFormNumberOfPeopleMax').val(maxPeople);

        $('#lunchFormSubmit').on('click', function(event) {
            var parameters = validateLunchForm();

            if (parameters !== false) {
                parameters.lunchId = lunchId;

                Sobremesa.callApi('lunch', 'POST', parameters, function(result) {
                    $('#lunchForm').modal('hide');
                    updateLunchView(lunchId);
                }, function(error) {
                    if (error.status == '400') {
                        Sobremesa.alert('Error', 'Invalid parameters');
                    } else if (error.status == '403') {
                        Sobremesa.alert('Error', 'You have no permission to edit this lunch');
                    } else if (error.status == '404') {
                        Sobremesa.alert('Error', 'Couldn\'t find the lunch');
                    } else {
                        Sobremesa.alert('Error', 'An unknown error occurred');
                    }
                });
            }
        });

        $('#lunchForm').modal('show');
    }

    function deleteLunch(lunchId) {
        Sobremesa.callApi('lunch', 'DELETE', {lunchId: lunchId}, function(result) {
            removeLunchView(lunchId);
        }, function(error) {
            if (error.status == '400') {
                Sobremesa.alert('Error', 'Invalid parameters');
            } else if (error.status == '403') {
                Sobremesa.alert('Error', 'You have no permission to delete this lunch');
            } else if (error.status == '404') {
                Sobremesa.alert('Error', 'Couldn\'t find the lunch');
            } else {
                Sobremesa.alert('Error', 'An unknown error occurred');
            }
        });
    }

    function joinLunch(lunchId) {
        Sobremesa.callApi('lunch/' + lunchId + '/member', 'PUT', null, function(result) {
            updateLunchView(lunchId);
        }, function(error) {
            if (error.status == '400') {
                Sobremesa.alert('Error', 'Invalid parameters');
            } else if (error.status == '404') {
                Sobremesa.alert('Error', 'Couldn\'t find the lunch');
            } else {
                Sobremesa.alert('Error', 'An unknown error occurred');
            }
        });
    }

    function cancelLunch(lunchId) {
        Sobremesa.callApi('lunch/' + lunchId + '/member', 'DELETE', null, function(result) {
            updateLunchView(lunchId);
        }, function(error) {
            if (error.status == '400') {
                Sobremesa.alert('Error', 'Invalid parameters');
            } else if (error.status == '404') {
                Sobremesa.alert('Error', 'Couldn\'t find the lunch');
            } else {
                Sobremesa.alert('Error', 'An unknown error occurred');
            }
        });
    }

    function logout() {
        Sobremesa.callApi('logout', 'GET', null, function(result) {
            Sobremesa.removeMe();
            window.location.href = 'login.html';
        }, function(error) {
            alert('Error', 'An unknown error occurred');
        }, false);
    }
    </script>
</body>
</html>
